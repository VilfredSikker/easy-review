# er-publish

Publish `.er-*` review artifacts to GitHub as a PR review with inline comments.

## Trigger

Run as `/er-publish`, `/er-publish <pr-number>`, or `/er-publish --approve`.

Flags:
- `<pr-number>` — target a specific PR (optional; defaults to the open PR for the current branch)
- `--approve` — submit as an approving review (APPROVE event); default is COMMENT (non-blocking)
- `--all` — include low and info severity findings as inline comments (default: high and medium only)

## What it does

1. Determines the target PR number
2. Reads `.er-review.json`, `.er-summary.md`, `.er-checklist.json`, and `.er-github-comments.json` from the repo root
3. Validates that the review data is fresh (diff_hash must match the current diff)
4. Builds a formatted review body (markdown) from the summary and checklist
5. Builds inline comment objects for high and medium severity findings (or all findings with `--all`)
6. Submits the review via `gh api`
7. Reports how many inline comments were posted and links to the PR

## Prerequisites check — REQUIRED FIRST

Before doing anything else, verify:

```
1. gh is installed:
   command -v gh
   If not found: "GitHub CLI (gh) is not installed. Install it: https://cli.github.com"

2. gh is authenticated:
   gh auth status
   If not authenticated: "GitHub CLI is not authenticated. Run: gh auth login"

3. .er-review.json exists in the repo root:
   If missing: "No review data found. Run /er-review first."
```

## Speed budget

**Target: ~8 tool calls total.** Build the payload JSON in-context — no jq, no intermediate temp files.

### Permission & hook constraints

All Bash commands MUST start with an allowed command: `git`, `shasum`, `gh`, `cp`, `mkdir`, `scripts/er-*`.
Do NOT chain `rm` with `&&`. Do NOT pipe into `shasum`.

## Step-by-step

```
TOOL CALL 1 — Bash (batch git metadata, one command):
  gh pr view --json number,url --jq '.number,.url' && gh repo view --json nameWithOwner --jq '.nameWithOwner'
  → Captures: PR number, PR URL, owner/repo
  → If gh pr view fails: bail "No open PR found for this branch."
  (If a PR number was passed as argument, skip the gh pr view and use it directly.)

TOOL CALLS 2-5 — Read all review artifacts (parallel):
  Read .er-review.json    (required — bail if missing: "No review data. Run /er-review first.")
  Read .er-summary.md     (optional — skip summary section if missing)
  Read .er-checklist.json (optional — skip checklist section if missing)
  Read .er-github-comments.json  (optional — include reviewer comments if diff_hash matches)

TOOL CALL 6 — Bash (freshness check via helper script):
  scripts/er-freshness-check.sh <base_branch>
  → Validates base ref, captures diff to .er-diff-tmp, outputs hash + commit
  → Compare hash with diff_hash from .er-review.json
  → If stale: bail "Review data is stale. Run /er-review first, then /er-publish."

IN-CONTEXT (zero tool calls) — Build the complete payload JSON:

  1. Build the review body markdown string:

     ## AI Review Summary
     <.er-summary.md contents, or one-paragraph summary from .er-review.json>

     ### Findings
     | Severity | Count |
     |----------|-------|
     | High     | <N>   |
     | Medium   | <N>   |
     | Low      | <N>   |
     | Info     | <N>   |

     <High severity findings listed>
     <Medium severity findings listed>

     ### Checklist
     <From .er-checklist.json if exists>

     ### Reviewer Comments
     <From .er-github-comments.json if fresh — includes all local unpushed comments>

     ---
     *Generated by [er](https://github.com/VilfredSikker/easy-review) — AI-assisted code review*

  2. Build inline comments array:
     For each finding in .er-review.json (high + medium by default, all with --all):
     - Skip if line_start is null/0/missing
     - Object: { "path", "line": line_start, "side": "RIGHT", "body": "**[SEV] title**\n\n..." }

  3. Assemble the full payload:
     { "body": "<review body, JSON-escaped>", "event": "COMMENT|APPROVE", "comments": [...] }

TOOL CALL 7 — Write /tmp/er_payload.json (the complete payload — built in-context, written once)

TOOL CALL 8 — Bash (submit):
  gh api repos/<owner>/<repo>/pulls/<number>/reviews --method POST --input /tmp/er_payload.json

Print: "Published review to PR #<number> with <M> inline comment(s)."
Print: "View at: <PR URL>"
If --approve: "Submitted as an approving review."
```

## Error handling

| Condition | Message |
|-----------|---------|
| `gh` not installed | "GitHub CLI (gh) is not installed. Install it: https://cli.github.com" |
| Not authenticated | "GitHub CLI is not authenticated. Run: gh auth login" |
| No open PR | "No open PR found for this branch. Push the branch and open a PR first, or pass the PR number explicitly." |
| `.er-review.json` missing | "No review data found. Run /er-review first." |
| Stale review data | "Review data is stale — the diff has changed since this review was generated. Run /er-review first, then re-run /er-publish." |
| `gh api` call fails | Print the gh error output. Then: "Failed to publish review. Check the error above." |

## Notes on --approve

Only use `event: "APPROVE"` when the `--approve` flag is **explicitly** present. The default `event: "COMMENT"` leaves the PR in a pending state, which is safer. Never infer approval intent — it must be stated.

## Notes on inline comment line numbers

GitHub requires the `line` field to be a valid line number in the diff. Use `line_start` from the finding. If `line_start` is absent or 0, skip that finding for inline placement — its text is still captured in the review body under the findings section.

## Notes on shell escaping

Build the complete JSON payload in-context and write it once with the Write tool. Then submit with `gh api --input /tmp/er_payload.json`. Never pass review body or comments as shell arguments.
